<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="styles/darkly.css">
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/5.0.0-alpha1/js/bootstrap.min.js" integrity="sha384-oesi62hOLfzrys4LxRF63OJCXdXDipiYWBnvTl9Y9/TRlw5xlKIEHpNyvvDShgf/" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <title>R&D - Returns Form</title>
    <script>
        
    </script>    
</head>

<style>
  textarea 
  {
    margin-bottom: 10px;
  }
</style>
<body>
  <nav class="navbar navbar-expand-lg bg-primary" data-bs-theme="dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">Detectronic R&D</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarColor01" aria-controls="navbarColor01" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarColor01">
        <ul class="navbar-nav me-auto">
          <li class="nav-item">
            <a class="nav-link" href="file:///C:/Users/DavidCunningham/VSCode/AWSAmplify/index.html">Dashboard
              <span class="visually-hidden">(current)</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="file:///C:/Users/DavidCunningham/VSCode/AWSAmplify/returns.html">Returns</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="file:///C:/Users/DavidCunningham/VSCode/AWSAmplify/testing.html">Testing</a>
          </li>
        </ul>
        <form class="d-flex">
          <div class="col"><button class="btn btn-outline-dark" type="submit">Log Out</button></div>
        </form>
      </div>
    </div>
  </nav>

  <div class="container-fluid">
    <div class="row">
      <main>
        <div class="col-md-auto ml-sm-auto col-lg-10 px-md-4">
          <h1>Test Data</h1>


        <h2>Testing Upload</h2>
        <form id="TestForm">
          <div class="row">
            <div class="col-md-3"> 
              <label for="SerialNumber">Serial Number:</label>
              <input type="number" class="form-control" id="SerialNumber">
              <label for="IMEI">IMEI:</label>
              <input type="number" class="form-control" id="IMEI">
              <label for="BatterySerial">Battery Serial:</label>
              <input type="number" class="form-control" id="BatterySerial">
              <label for="BatteryVoltage">Battery Voltage:</label>
              <input type="text" class="form-control" id="BatteryVoltage">
              <label for="DeviceName">Device Name:</label>
              <input type="text" class="form-control" id="DeviceName">
              <label for="DateOfTest">Date of Test:</label>
              <input type="datetime" class="form-control" id="DateOfTest">
              <label for="WS46Plus">WS46+ Settings:</label>
              <input type="text" class="form-control" id="WS46Plus">
              <label for="Bootstrapped">Bootstrap Time:</label>
              <input type="datetime" class="form-control" id="Bootstrapped">
              <label for="ATEX">Pass/Fail:</label>
              <select class="form-control" id="ATEX">
                <option class="option" value="NONE"></option>
                <option class="option" value="PASS">Pass</option>
                <option class="option" value="FAIL">Fail</option>
              </select>
              
            </div>
            <div class="col-md-3">  
              <label for="PrimaryDistance">First Distance:</label>
              <input type="number" class="form-control" id="PrimaryDistance">
              <label for="SecondaryDistance">Second Distance:</label>
              <input type="number" class="form-control" id="SecondaryDistance">
              <label for="TertiaryDistance">Third Distance</label>
              <input type="number" class="form-control" id="TertiaryDistance">
              <label for="ModbusOffset">Modbus Offset:</label>
              <input type="number" class="form-control" id="ModbusOffset">
              <label for="ModemVersion">Modem Version:</label>
              <input type="text" class="form-control" id="ModemVersion">
              <label for="FirmwareVersion">Firmware Version:</label>
              <input type="text" class="form-control" id="FirmwareVersion">
              <label for="WS46Hash">WS46# Settings:</label>
              <input type="text" class="form-control" id="WS46Hash">
              <label for="Registered">Registration Time:</label>
              <input type="datetime" class="form-control" id="Registered">
              <label for="FailReason">Fail Reason:</label>
              <input type="text" class="form-control" id="FailReason">
            </div>
            <div class="col-md-3">  
              <label for="LastAttemptedSend">Last Attempted Send:</label>
              <input type="datetime" class="form-control" id="LastAttemptedSend">
              <label for="LastSuccessfulSend">Last Successful Send:</label>
              <input type="datetime" class="form-control" id="LastSuccessfulSend">
              <label for="Coordinates">Coordinates:</label>
              <input type="text" class="form-control" id="Coordinates">
              <label for="MobileNetwork">Mobile Network:</label>
              <input class="form-control" id="MobileNetwork">
              <label for="ConnectionType">Connection Type:</label>
              <input type="text" class="form-control" id="ConnectionType">
              <label for="RSSI">RSSI:</label>
              <input class="form-control" id="RSSI">
              <label for="Exec">Exec Time:</label>
              <input type="datetime" class="form-control" id="Exec">
              <label for="CompetentPerson">Competent Person:</label>
              <input type="text" class="form-control" id="CompetentPerson">
              <label for="PointOfOrigin">Point Of Origin:</label>
              <input type="text" class="form-control" id="PointOfOrigin">
            </div>              
          </div>
          <label for="Comments" class="form-label">Comments</label>
          <textarea class="form-control col-md-9" id="Comments" rows="4"></textarea>
          <button id="submitUnitDetails" type="button" class="btn btn-primary form-control col-md-9" onclick="postAPI(TestForm)">Submit!</button>
        </form>
        <div class="pt-2 pb-2 mb-3 "></div>


        <h2>Get Unit Details</h2>
        <form id="TestForm">
          <div class="row">
            <div class="col-md-3">
              <label for="Filter" class="form-label">Filter Type:</label>
              <select id="Filter" class="form-control">
                  <option value="SerialNumber">Serial Number</option>
                  <option value="BatterySerial">Battery Serial</option>
                  <option value="IMEI">IMEI</option>
                  <option value="FailState">Fail State</option>
              </select>
            </div>
            <div class="col-md-3">
              <label for="FilterInput" class="form-label">Filter By:</label>
              <input type="text" id="FilterInput" class="form-control">
            </div>
            <div class="col-md-3">
              <label for="submitUnitDetails" class="form-label">Get Data:</label>
              <button id="submitUnitDetails" type="button" class="btn btn-primary form-control bottom" onclick="getFilterAPI(Filter,FilterInput)">Get!</button>
            </div>
          </div>
        </form>
      </div>
      <div class="pt-2 pb-2 mb-3 "></div>
      
        <table id="UnList" class="table table-bordered table-responsive table-hover table-sm table-dark " width="900" height="1000"></table>
      </main>
    </div>
  </div>   
</body>
<script>
  // callAPI function that takes the base and exponent numbers as parameters
  var callAPI = (base,exponent)=>{
      // instantiate a headers object
      var myHeaders = new Headers();
      // add content type header to object
      myHeaders.append("Content-Type", "application/json");
      // using built in JSON utility package turn object to string and store in a variable
      var raw = JSON.stringify({"base":base,"exponent":exponent});
      // create a JSON object with parameters for API call and store in a variable
      var requestOptions = {
          method: 'POST',
          headers: myHeaders,
          body: raw,
          redirect: 'follow'
      };
      // make API call with parameters and use promises to get response
      fetch("https://n6uac60or4.execute-api.eu-west-1.amazonaws.com/beta/", requestOptions)
      .then(response => response.text())
      .then(result => alert(JSON.parse(result).body))
      .catch(error => console.log('error', error));
  }

  // callAPI function that takes the base and exponent numbers as parameters
  var generalAPI = (SerialNumber,BatterySerial,IMEI,FailState,FailReason)=>{
      // instantiate a headers object
      var myHeaders = new Headers();
      // add content type header to object
      myHeaders.append("Content-Type", "application/json");
      // using built in JSON utility package turn object to string and store in a variable
      var raw = JSON.stringify({"SerialNumber":SerialNumber,"BatterySerial":BatterySerial,"IMEI":IMEI,"FailState":FailState,"FailReason":FailReason});
      // create a JSON object with parameters for API call and store in a variable
      var requestOptions = {
          method: 'POST',
          headers: myHeaders,
          body: raw,
          redirect: 'follow'
      };
      // make API call with parameters and use promises to get response
      fetch("https://n6uac60or4.execute-api.eu-west-1.amazonaws.com/beta/", requestOptions)
      .then(response => response.text())
      .then(result => alert(JSON.parse(result).body))
      .catch(error => window.alert('error', error));
  }
  var postAPI = (form)=>{
      console.log("Form Parse Start")
      let object = {};
      var FailEnabled = false;
      for (var data of form.elements) {
          if(data.id == "FailState")
          {
              if(data.value=="Pass")
              {FailEnabled = false;}
              if(data.value=="Fail")
              {FailEnabled = true;}
          }
          if(data.id != '' || data.value != ''){
              if(data.id!='FailReason' || (data.id=='FailReason' && FailEnabled)){
                  console.log(data.value, FailEnabled);
                  object[data.id]=(data.value);}
              }
      }
      console.log(object);            
      // instantiate a headers object
      var myHeaders = new Headers();
      // add content type header to object
      myHeaders.append("Content-Type", "application/json");
      // create a JSON object with parameters for API call and store in a variable
      var requestOptions = {
          method: 'POST',
          headers: myHeaders,
          body: object,
          redirect: 'follow'
      };
      console.log(requestOptions);
      var url = "https://n6uac60or4.execute-api.eu-west-1.amazonaws.com/beta/query1"
      // make API call with parameters and use promises to get response
      fetch(url, requestOptions)
      .then(response => response.text())
      .then(result => alert(JSON.parse(result).body))
      .catch(error => window.alert('error', error));
  }  
  var getFilterAPI = (Filter,FilterInput)=>{
      if(FilterInput.value == "")
      {
          window.alert("Filter Field Missing Value");
          return;
      }
      x = Filter;
      var json = {"Filter":Filter.value,"Value":FilterInput.value};
      //json = JSON.stringify({"SerialNumber":SerialNumber.value});
      var url = "https://n6uac60or4.execute-api.eu-west-1.amazonaws.com/beta/query1"
      var query = encodeQuery(json);
      givenUrl = url +"?"+ query;
      console.log(givenUrl);
      // add content type header to object
      const headers = {
          "Content-Type": "application/json"
      };
      // create a JSON object with parameters for API call and store in a variable
      var requestOptions = {
          method: 'GET',
          headers: headers,
          redirect: 'follow',
      };
      // make API call with parameters and use promises to get response
      fetch(givenUrl, requestOptions)
      .then(response => response.text())
      .then(result => displayGetData(result))
      .catch(error => window.alert('error', error));
  }
  function displayGetData(data){
      //Define and Clear old Table
      let list = document.getElementById("UnList");
      list.innerHTML = "";
      
      
      //Parse JSON Data
      parsedData = JSON.parse(data);
      console.log(parsedData);
      var id = "";
      
      console.log(data);
      //Check if data is valid
      if(parsedData.message ==("Internal server error"))
      {
          window.alert("Internal Server Error")
          return;
      }

      //Define Header
      var HeaderRow = list.insertRow(0);
      var HeadCells = [];
      var HeadInt = 0;

      //Add Data to Header
      for(let column in parsedData[0]){
          HeadCells[HeadInt] = HeaderRow.insertCell();
          HeadCells[HeadInt].textContent = [column];
              HeadInt += 1;
      }
      list.appendChild(HeaderRow);

      //Add Parsed Data to Rows
      x = true;
      for (let row in parsedData) {
          console.log(parsedData[row]);
          //var li = document.createElement("row"+row);
          var TRow = list.insertRow(row);
          var cells = [];
          var tempInt = 0;
          for(let column in parsedData[row]){
              //var col = li.insertCell(column);
              //const newCell = document.createElement("row").insertCell();
              //newCell.textContent = column;
              //cells[tempInt] = TRow.insertCell(parsedData[row][column]);
              //cells[tempInt].innerHTML = parsedData[row].ConnectionType;
              cells[tempInt] = TRow.insertCell();
              cells[tempInt].textContent = parsedData[row][column];
              tempInt += 1;
          }
          list.appendChild(TRow);
      }
      
      // for (let column in parsedData[0]){
          
      // }

      // for (let i in parsedData)
      // {
      //     id = "SerialNumber"+i
      //     document.getElementById(id).innerHTML += parsedData[i].SerialNumber;
      // }
  }
  function encodeQuery(data) {
      let query = ""
      for (let d in data)
          query += encodeURIComponent(d) + '='
              + encodeURIComponent(data[d]) + '&'
      return query.slice(0, -1)
  }
  function testAPI(){
      var url = "https://n6uac60or4.execute-api.eu-west-1.amazonaws.com/beta/"
      //var query = encodeQuery();
      
      // add content type header to object
      const headers = {
          "Content-Type": "application/json"
      };
      // create a JSON object with parameters for API call and store in a variable
      var requestOptions = {
          method: 'GET',
          headers: headers,
          redirect: 'follow',
      };
      givenUrl = "https://n6uac60or4.execute-api.eu-west-1.amazonaws.com/beta/query1"
      console.log(requestOptions,givenUrl);
      // make API call with parameters and use promises to get response
      fetch(givenUrl, requestOptions)
      .then(response => response.text())
      .then(result => console.log(result))
      .catch(error => console.log('error', error));
  }
</script>
</html>