<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="styles/darkly.css">
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/5.0.0-alpha1/js/bootstrap.min.js" integrity="sha384-oesi62hOLfzrys4LxRF63OJCXdXDipiYWBnvTl9Y9/TRlw5xlKIEHpNyvvDShgf/" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>


    <title>R&D - Returns Form</title>
    <script>
      function openTab(evt, tabName,objs) {
        // Declare all variables
        var i, tabcontent, tablinks;
        if(objs == "Click"){
        // Get all elements with class="tabcontent" and hide them
        tabcontent = document.getElementsByClassName("tabcontent");
        for (i = 0; i < tabcontent.length; i++) {
          tabcontent[i].style.display = "none";
        }

        // Get all elements with class="tablinks" and remove the class "active"
        tablinks = document.getElementsByClassName("nav-link");
        for (i = 0; i < tablinks.length; i++) {
          tablinks[i].className = tablinks[i].className.replace(" active", "");
        }

        // Show the current tab, and add an "active" class to the button that opened the tab
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.className += " active";
        window.history.pushState('', '', '/#'+tabName);
      }
      if (objs == "Reload"){

        // Declare all variables
        
        // Get all elements with class="tabcontent" and hide them
        tabcontent = document.getElementsByClassName("tabcontent");
        for (i = 0; i < tabcontent.length; i++) {
          tabcontent[i].style.display = "none";
        }

        // Get all elements with class="tablinks" and remove the class "active"
        tablinks = document.getElementsByClassName("nav-link");
        for (i = 0; i < tablinks.length; i++) {
          tablinks[i].className = tablinks[i].className.replace(" active", "");
        }

        //make the given tab active
        switch(tabName){
          case "Dashboard":
            Dashboard.style.display = "block";
            DashboardTitle.className += " active";

            break;
          case "Testing":
            Testing.style.display = "block";
            TestingTitle.className += " active";
            break;
          case "Returns":
            Returns.style.display = "block";
            ReturnsTitle.className += " active";
            break;
        }
      }
    } 
      
      
  // callAPI function that takes the base and exponent numbers as parameters
  var callAPI = (base,exponent)=>{
      // instantiate a headers object
      var myHeaders = new Headers();
      // add content type header to object
      myHeaders.append("Content-Type", "application/json");
      // using built in JSON utility package turn object to string and store in a variable
      var raw = JSON.stringify({"base":base,"exponent":exponent});
      // create a JSON object with parameters for API call and store in a variable
      var requestOptions = {
          method: 'POST',
          headers: myHeaders,
          body: raw,
          redirect: 'follow'
      };
      // make API call with parameters and use promises to get response
      fetch("https://n6uac60or4.execute-api.eu-west-1.amazonaws.com/beta/", requestOptions)
      .then(response => response.text())
      .then(result => alert(JSON.parse(result).body))
      .catch(error => console.log('API Call Error', error));
  }

  // callAPI function that takes the base and exponent numbers as parameters
  var generalAPI = (SerialNumber,BatterySerial,IMEI,FailState,FailReason)=>{
      // instantiate a headers object
      var myHeaders = new Headers();
      // add content type header to object
      myHeaders.append("Content-Type", "application/json");
      // using built in JSON utility package turn object to string and store in a variable
      var raw = JSON.stringify({"SerialNumber":SerialNumber,"BatterySerial":BatterySerial,"IMEI":IMEI,"FailState":FailState,"FailReason":FailReason});
      // create a JSON object with parameters for API call and store in a variable
      var requestOptions = {
          method: 'POST',
          headers: myHeaders,
          body: raw,
          redirect: 'follow'
      };
      // make API call with parameters and use promises to get response
      fetch("https://n6uac60or4.execute-api.eu-west-1.amazonaws.com/beta/", requestOptions)
      .then(response => response.text())
      .then(result => alert(JSON.parse(result).body))
      .catch(error => window.alert('General API Error', error));
  }
  var TestingAPIFormat = (form)=>{
    let Database = "testing";
    TestPostAPI(form,Database);
  }
  var ReturnsAPIFormat = (form)=>{
    let Database = "returns";
    TestPostAPI(form,Database);
  }
  var TestPostAPI = (form,Database)=>{
      console.log("Form Parse Start")
      let object = {};
      var ATEXCompliant = false;
      for (var data of form.elements) 
      {
        console.log(data.id, data.value);
        if(data.id == "SensorTest")
        {
          if(data.value=="NONE")
          {
            window.alert("Mandatory Fields Missing")
            return;
          }
        }
        if(data.id == "CommsTest")
        {
          if(data.value=="NONE")
          {
            window.alert("Mandatory Fields Missing")
            return;
          }
        }
        if(data.id == "Status")
        {
          if(data.value=="NONE")
          {
            window.alert("Mandatory Fields Missing")
            return;
          }
        }
        if(data.id == "ATEX")
        {
          if(data.value=="NONE")
          {
            window.alert("Mandatory Fields Missing")
            return;
          }
        }
        object[data.id]=(data.value);
      }
      if(Database == "testing"){
      //Process the Data to fit the model 
      formattedObject = {"Parameters":TestFormatter(object),"Database":Database}}
      if(Database == "returns"){formattedObject = {"Parameters":ReturnFormatter(object),"Database":Database}}
      //Send to API for adding to database.
      TestAPIPost(formattedObject);
    }
    var TestFormatter = (object)=>{
      formatObject= {};
      formatObject[0] = object.SerialNumber;
      formatObject[1] = object.IMEI;
      formatObject[2] = object.DateOfTest;
      formatObject[3] = object.PrimaryDistance;
      formatObject[4] = object.SecondaryDistance;
      formatObject[5] = object.TertiaryDistance;
      formatObject[6] = object.ModbusOffset;
      formatObject[7] = object.BatterySerial;
      formatObject[8] = object.BatteryVoltage;
      formatObject[9] = object.ModemVersion;
      formatObject[10] = object.FirmwareVersion;
      formatObject[11] = object.DeviceName;
      formatObject[12] = object.LastAttemptedSend;
      formatObject[13] = object.LastSuccessfulSend;
      formatObject[14] = object.Coordinates;
      formatObject[15] = object.MobileNetwork;
      formatObject[16] = object.ConnectionType;
      formatObject[17] = object.RSSI;
      formatObject[18] = object.WS46Plus;
      formatObject[19] = object.WS46Hash;
      formatObject[20] = object.Bootstrapped;
      formatObject[21] = object.Registered;
      formatObject[22] = object.Exec;
      formatObject[23] = object.ATEX;
      formatObject[24] = object.FailReason;
      formatObject[25] = "Abdul Rahman";
      formatObject[26] = object.CompetentPerson;
      formatObject[27] = object.PointOfOrigin;
      return formatObject;
    }
    var ReturnFormatter = (object)=>{
      console.log(object);
      formatObject = {};
      formatObject[0] = object.BatterySerial;
      formatObject[1] = object.BatteryVoltage;
      formatObject[2] = object.Comments;
      formatObject[3] = object.CommsError;
      formatObject[4] = object.CommsTest;
      formatObject[5] = object.Customer;
      formatObject[6] = object.DateReturned;
      formatObject[7] = object.FaultCategory;
      formatObject[8] = object.FixApplied;
      formatObject[9] = object.History;
      formatObject[10] = object.IMEI;
      formatObject[11] = object.Product;
      formatObject[12] = object.ProductCode;
      formatObject[13] = object.ReturnReason;
      formatObject[14] = "Abdul Rahman";
      formatObject[15] = object.SensorError;
      formatObject[16] = object.SensorTest;
      formatObject[17] = object.SerialNumber;
      formatObject[18] = object.Status;
      formatObject[19] = object.Tags;
      formatObject[20] = new Date().toLocaleString();
      formatObject[21] =object.VisualComments;
      formatObject[22] = object.VisualInspection;
      console.log(formatObject);
      return formatObject;
      
    }
    var TestAPIPost = (object)=>{  
      // instantiate a headers object
      var myHeaders = new Headers();
      // add content type header to object
      var obj = JSON.stringify(object);
      console.log(obj);
      myHeaders.append("Content-Type", "application/json");
      // create a JSON object with parameters for API call and store in a variable
      var requestOptions = {
          method: 'POST',
          headers: myHeaders,
          body: obj,
          redirect: 'follow'
      };
      var url = "https://n6uac60or4.execute-api.eu-west-1.amazonaws.com/beta/testing"
      // make API call with parameters and use promises to get response
      fetch(url, requestOptions)
      .then(response => response.text())
      .then(result => console.log(JSON.parse(result).body))
      .catch(error => console.log('Post API Error'+ error));
  }
  var getReturnsFilterAPI = (Filter,FilterInput)=>{
    Database = "returns";
    getFilterAPI(Database,Filter,FilterInput);
  }
  var getTestingFilterAPI = (Filter,FilterInput)=>{
    Database = "testing";
    getFilterAPI(Database,Filter,FilterInput);
  }
  var getUnitFilterAPI = (Filter,FilterInput)=>{
    Database = "units";
    getFilterAPI(Database,Filter,FilterInput);
  }
  var getFilterAPI = (Database,Filter,FilterInput)=>{
    console.log(Database);
    console.log(Filter);
    console.log(FilterInput);
      if(FilterInput.value == "")
      {
          window.alert("Filter Field Missing Value");
          return;
      }
      x = Filter;
      var url = "https://n6uac60or4.execute-api.eu-west-1.amazonaws.com/beta/"+Database
      var DatabasePointer = "";
      if(Database == "returns"){DatabasePointer = "ReturnsData";}
      if(Database == "testing"){DatabasePointer = "RigData";}
      if(Database == "units"){DatabasePointer = "UnitData";}
      var json = {"Database":DatabasePointer,"Filter":Filter.value,"Value":FilterInput.value};
      //json = JSON.stringify({"SerialNumber":SerialNumber.value});
      
      var query = encodeQuery(json);
      givenUrl = url +"?"+ query;
      console.log("Given URL:")
      console.log(givenUrl);
      // add content type header to object
      const headers = {
          "Content-Type": "application/json"
      };
      // create a JSON object with parameters for API call and store in a variable
      var requestOptions = {
          method: 'GET',
          headers: headers,
          redirect: 'follow',
      };
      // make API call with parameters and use promises to get response
      fetch(givenUrl, requestOptions)
      .then(response => response.text())
      .then(result => displayGetData(result,Database))
      .catch(error => window.alert('Filter API Error', error));
  }
  function displayGetData(data,Database){
      //Define and Clear old Table
      let list = document.getElementById("UnListTest");
      if(Database == "returns"){
        list = document.getElementById("UnListReturn");
      }
      
      list.innerHTML = "";
      //Parse JSON Data
      parsedData = JSON.parse(data);
      console.log(parsedData);
      var id = "";
      console.log(data);
      //Check if data is valid
      if(parsedData.message ==("Internal server error"))
      {
          window.alert("Internal Server Error")
          return;
      }
      //Define Header
      var HeaderRow = list.insertRow(0);
      var HeadCells = [];
      var HeadInt = 0;
      //Add Data to Header
      for(let column in parsedData[0]){
          HeadCells[HeadInt] = HeaderRow.insertCell();
          HeadCells[HeadInt].textContent = [column];
              HeadInt += 1;
      }
      list.appendChild(HeaderRow);
      //Add Parsed Data to Rows
      x = true;
      for (let row in parsedData) {
          console.log(parsedData[row]);
          //var li = document.createElement("row"+row);
          var TRow = list.insertRow(row);
          var cells = [];
          var tempInt = 0;
          for(let column in parsedData[row]){
              //var col = li.insertCell(column);
              //const newCell = document.createElement("row").insertCell();
              //newCell.textContent = column;
              //cells[tempInt] = TRow.insertCell(parsedData[row][column]);
              //cells[tempInt].innerHTML = parsedData[row].ConnectionType;
              cells[tempInt] = TRow.insertCell();
              cells[tempInt].textContent = parsedData[row][column];
              tempInt += 1;
          }
          list.appendChild(TRow);
        }
      // for (let column in parsedData[0]){
          
      // }

      // for (let i in parsedData)
      // {
      //     id = "SerialNumber"+i
      //     document.getElementById(id).innerHTML += parsedData[i].SerialNumber;
      // }
      }
  function encodeQuery(data) {
          let query = ""
          for (let d in data)
              query += encodeURIComponent(d) + '='
                  + encodeURIComponent(data[d]) + '&'
          return query.slice(0, -1)
      }
  function testAPI(){
          var url = "https://n6uac60or4.execute-api.eu-west-1.amazonaws.com/beta/"
          //var query = encodeQuery();
          
          // add content type header to object
          const headers = {
              "Content-Type": "application/json"
          };
          // create a JSON object with parameters for API call and store in a variable
          var requestOptions = {
              method: 'GET',
              headers: headers,
              redirect: 'follow',
          };
          givenUrl = "https://n6uac60or4.execute-api.eu-west-1.amazonaws.com/beta/query1"
          console.log(requestOptions,givenUrl);
          // make API call with parameters and use promises to get response
          fetch(givenUrl, requestOptions)
          .then(response => response.text())
          .then(result => console.log(result))
          .catch(error => console.log('Test API Error', error));
      }
      function TableHide(TableVar){
        $("#"+TableVar).hide("slow");
        console.log("Hide "+TableVar+" List Complete")
      }
      function TableShow(TableVar){
        $("#"+TableVar).show("slow");
      }
  function CSVParse(line){
      let object = {};
      var skipHeader = false;
      var i =0;
      for (var data of line)
      {
        object[i]=data;
        i++;
      }
      if (Object.keys(object)[0] == "0")
      {
        if ((String(object["0"]) == "") || (String(object["0"]) == "Serial Number")){ console.log("Skip Line"); return;}
        console.log(object);
        TestAPIPost(object);
        console.log("Line Parse Complete");
      }
    }
  function ProductSelect(ProductSelect){
    ProductVariant = document.getElementById("ProductVariant");
    ProductCode = document.getElementById("ProductCode");
    if(ProductSelect.value == "LIDoTT SMART V1")
    {
      switch(ProductVariant.value) {
        default:
          ProductCode.value = "P131-1";
      }
    }
    if(ProductSelect.value == "LIDoTT SMART V2")
    {
      switch(ProductVariant.value) {
        case "A":
          ProductCode.value = "P131-SRT-A-2";
          break;
        case "B":
          ProductCode.value = "P131-SRT-B-2";
          break;
        case "C":
          ProductCode.value = "P131-SRT-C-2";
          break;
        default:
          ProductCode.value = "Invalid Product";
      }
    }
    if(ProductSelect.value == "LIDoTT ALARM")
    {
      switch(ProductVariant.value) {
        case "A":
          ProductCode.value = "P134-2-A";
          break;
        case "B":
          ProductCode.value = "P134-2-B";
          break;
        case "C":
          ProductCode.value = "P134-2-C";
          break;
        case "D":
          ProductCode.value = "P134-2-D";
          break;
        default:
          ProductCode.value = "Invalid Product";
      }
    }
    if(ProductSelect.value == "NONE"){
      document.getElementById("ProductCode").value = "Invalid Product";
    }
  }
</script>
</head>
<style>
  textarea 
  {
    margin-bottom: 10px;
  }
  /* Style the tab content */
  .tabcontent {
    display: none;
    padding: 6px 12px;
    border-top: none;
  }
  .tabcontent {
  animation: fadeEffect 1s; /* Fading effect takes 1 second */
  }

  /* Go from zero to full opacity */
  @keyframes fadeEffect {
    from {opacity: 0;}
    to {opacity: 1;}
  }
  .clickable {
    cursor: pointer;
  }
  a:hover {
    font-size: 101%;
  }
</style>
<script>
  const yValues = [55, 33, 49, 24];
  const barColors = ["red","green","blue","gray"];
</script>
<script>
function RenderDeviceType(){
  new Chart("DeviceTypeChart", {
  type: "doughnut",
  data: {
    labels: ["Alarm", "Smart V1", "Smart V2", "Ultrasonic Sensor"],
    datasets: [{
    backgroundColor: barColors,
    data: yValues
    }]
  },
  options: {
      title: {
      display: true,
      text: "Device Type Testing Breakdown"
      }
  }
  });
}
  function RenderPassFail(){
    //get data from database
    var PassFailData = [43,12] 
    new Chart("PassFailChart", {
    type: "bar",
    data: {
      labels: ["Pass", "Fail"],
      datasets: [{
      backgroundColor: ["green","red"],
      data: PassFailData
      }]
    },
    options: {
        title: {
        display: true,
        text: "Device Testing Results Breakdown"
        },
        legend: {
                display: false
        }        
    }
  });
}
  function RenderTestHistory(){
    //get data from database
    var testHistoryX = ["2016-12-25","2016-12-26","2016-12-27","2016-12-28"]
    var testHistoryY = [12,15,8,26]
    var TestHistoryData = [{x:"2024-12-25",y:12},{x:"2024-12-26",y:15},{x:"2024-12-27",y:8},{x:"2024-12-28",y:26}]
    
    new Chart("TestHistoryChart", {
    type: "line",
    data: {
      labels: testHistoryX,
      datasets: [{
        backgroundColor: 'rgba(154, 52, 235, 0.5)',
        data: testHistoryY
      }]
    },
    options: {
        title: {
        display: true,
        text: "Device Testing History"
        },
        legend: {
                display: false
        },
        elements:{ 
          point:{
            radius:5
          }
        }
    }
  });
  }
  function DashboardPress(event,text)
  {
    openTab(event, text,"Click");
    RefreshGraphs();
  }
  function RefreshGraphs()
  {
    RenderDeviceType();
    RenderPassFail();
    RenderTestHistory();
  }
  function GetPage()
  {
    //if page is dashboard or default
    var currentUrl = (window.location.href);
    console.log(currentUrl);
    //scrub base url then split by & to just get the chosen page
    var currentParams = (currentUrl.replace("https://main.d23gwgub2u9aya.amplifyapp.com","")).replace("/","").replace("#","").split("+");
    var currentPage = currentParams[0];
    if(currentPage == ""){currentPage="Dashboard"}
    switch(currentPage) {
      case "Testing":
        currentPage = "RigData"
        break;
      case "Returns":
        currentPage = "ReturnsData"
        break;
      default:
        currentPage == "Dashboard"
        break;
    }
    openTab(null,currentPage,"Reload");
    if (currentPage == "Dashboard")
    {
      var databaseChosen = "";
      var dateTimeChosen = "";
      if(currentParams.length == 3)
      {
        databaseChosen=currentParams[1];
        dateTimeChosen=currentParams[2];
      }
      //parse testing or returns & datetime period chosen
      GetGraphData(databaseChosen, dateTimeChosen);
      //else do nothing
      RefreshGraphs();
    }
  }
  function GetGraphData(DatabaseChosen,DatetimeChosen)
  {
    //Get selected database
    var DataBase = "";
    switch(DatabaseChosen) {
      case "":
        DataBase = "RigData"
        break;
      case "Testing":
        DataBase = "RigData"
        break;
      case "Returns":
        DataBase = "ReturnsData"
        break;
      default:
        window.alert("Invalid Url Detected \n\r Default Selected");
        DataBase = "RigData";
        DatetimeChosen = "Week";
        break;
    }

    switch(DatetimeChosen) {
      case "":
        DataBase = "Weekly"
        break;
      case "Day":
        DataBase = "Daily"
        break;
      case "Week":
        DataBase = "Weekly"
        break;
      case "Month":
        DataBase = "Monthly"
        break;
      case "Year":
        DataBase = "Yearly"
        break;
      default:
        window.alert("Invalid Url Detected \n\r Default Selected");
        DataBase = "RigData";
        DatetimeChosen = "Week";
        break;
    }
    //Get data from database for given time period
    var xData = GraphDataAPI(DataBase,DatetimeChosen)
    //Parse amount of tests for Graph 1
    //Parse Device Type data for Graph 2
    //Parse Pass/Fail data for Graph 3
  }
  function GraphDataAPI(Database, Timescale)
      {
      var url = "https://n6uac60or4.execute-api.eu-west-1.amazonaws.com/beta/";
      var json = {"Database":Database,"Dashboard":Timescale};
      
      var query = encodeQuery(json);
      givenUrl = url +"?"+ query;
      console.log("Given URL:")
      console.log(givenUrl);
      // add content type header to object
      const headers = {
          "Content-Type": "application/json"
      };
      // create a JSON object with parameters for API call and store in a variable
      var requestOptions = {
          method: 'GET',
          headers: headers,
          redirect: 'follow',
      };
      // make API call with parameters and use promises to get response
      fetch(givenUrl, requestOptions)
      .then(response => response.text())
      .then(result => displayGetData(result,Database))
      .catch(error => console.log('Filter API Error', error));
  }
  function DateTimeChange(){
    var text = timescale.options[timescale.selectedIndex].text;
    console.log(text);
    UpdateURL("",text)
  }
  function TestReturnPress(context){
    switch(context) {
      case 'Testing':
        if (!(TestingDBButton.className.includes(" active"))){
        TestingDBButton.className += " active";
        ReturnsDBButton.className = ReturnsDBButton.className.replace(" active", "");
        UpdateURL("Testing","");
        }
        break;
      case 'Returns':
      if (!(ReturnsDBButton.className.includes(" active"))){
        ReturnsDBButton.className += " active";
        TestingDBButton.className = TestingDBButton.className.replace(" active", "");
        UpdateURL("Returns","");
        }
        break;
      default:
        if (!(TestingDBButton.className.includes(" active"))){
        TestingDBButton.className += " active";
        ReturnsDBButton.className = ReturnsDBButton.className.replace(" active", "");
        UpdateURL("Testing","");
        }
    }
  }
  function UpdateURL(database,datetime)
  {
    var currentUrl = (window.location.href);
    var currentParams = (currentUrl.replace("https://main.d23gwgub2u9aya.amplifyapp.com","")).replace("/","").replace("#","").split("+");
    if(currentParams.length == 3)
    {
      var databaseChosen=currentParams[1];
      var dateTimeChosen=currentParams[2];
      if(database != ""){databaseChosen = datebase;}
      if(datetime != ""){dateTimeChosen = datetime;}
      var setUrl = "https://main.d23gwgub2u9aya.amplifyapp.com/#Dashboard"+databaseChosen+"+"+dateTimeChosen;
      window.location.href=setUrl;
    }
  }
</script>
<script>
  function OnAppearing()
  {
    GetPage();
    //TableHide("UnListTest")
    //console.log("Hide List Complete")
  }
</script>
<body onload="OnAppearing()">
  <nav class="navbar navbar-expand-lg bg-primary" data-bs-theme="dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="https://main.d23gwgub2u9aya.amplifyapp.com/">Detectronic R&D</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarColor01" aria-controls="navbarColor01" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarColor01">
        <ul class="navbar-nav me-auto">
          <li class="nav-item">
            <a id="DashboardTitle" class="nav-link clickable" id="defaultOpen" onclick="DashboardPress(event, 'Dashboard')">Dashboard
              <span class="visually-hidden">(current)</span>
            </a>
          </li>
          <li class="nav-item">
            <a id="ReturnsTitle" class="nav-link clickable" onclick="openTab(event, 'Returns','Click')">Returns</a>
          </li>
          <li class="nav-item">
            <a id="TestingTitle" class="nav-link clickable" onclick="openTab(event, 'Testing','Click')">Testing</a>
          </li>
        </ul>
        <form class="d-flex">
          <div class="col"><button class="btn btn-outline-dark" type="submit">Log Out</button></div>
        </form>
      </div>
    </div>
  </nav>
  <div class="container-fluid">
    <!-- Tab content -->
    <div id="Dashboard" class="tabcontent">
      <div class="row">
        <main class="col-md-auto ml-sm-auto col-lg-10 px-md-4">
          <div
            class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3">
          </div>
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
              <h1 class="h2">Dashboard</h1>
              <div class="btn-toolbar mb-2 mb-md-0">
                <button type="button" class="btn btn-sm btn-outline-secondary btn-light" style="margin-right:5px;">Export</button>
                <select name="timescalePicker" id="timescale" onchange="DateTimeChange()" style="margin-right:5px;"  class="btn btn-sm btn-outline-secondary btn-light d-flex align-items-center gap-1">
                  <option value="all">All</option>
                  <option value="day">Day</option>
                  <option value="week">Week</option>
                  <option value="month">Month</option>
                  <option value="year">Year</option>
                </select>
                
                <div class="btn-group me-2 align-right btn-toolbar mb-2 mb-md-0">
                  <button id="TestingDBButton" type="button" class="btn btn-sm btn-outline-secondary btn-light" onclick="TestReturnPress('Testing')">Testing</button>
                  <button id="ReturnsDBButton" type="button" class="btn btn-sm btn-outline-secondary btn-light" onclick="TestReturnPress('Returns')">Returns</button>
                </div>
              </div>
            </div>
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3">
              <h2 >Device Breakdown</h2>
            </div>
            <div style="background-color: lightgray; border-radius: 25px;">
              <canvas id="TestHistoryChart" style="max-width:550px;display:inline-block;margin-left:2%;margin-top:10px; margin-bottom:10px;"></canvas>
              <canvas id="DeviceTypeChart" style="max-width:550px;display:inline-block;margin-top:10px; margin-bottom:10px;"></canvas>
              <canvas id="PassFailChart" style="max-width:550px;display:inline-block;margin-top:10px; margin-bottom:10px;margin-left:20px;margin-right:20px"></canvas>
            </div>
            
            <div style="width:100%;float:inline-start;margin-top:20px">
              <h2>Recent Tests</h2>
              <div class="table-responsive small">
                <table class="table table-striped table-sm">
                  <thead>
                    <tr>
                      <th scope="col">Test Time</th>
                      <th scope="col">Serial Number</th>
                      <th scope="col">IMEI</th>
                      <th scope="col">Device </th>
                      <th scope="col">Pass/Fail</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>13:25 28-08-2025</td>
                      <td>1342390003604</td>
                      <td>3559399156480</td>
                      <td>Alarm</td>
                      <td>Pass</td>
                    </tr>                   
                  </tbody>
                </table>
              </div>
          </main>
        </div>
      </div>
    </div>
    
    <div id="Returns" class="tabcontent">
      <div class="row">
        <main class="col-md-auto ml-sm-auto col-lg-10 px-md-4">
          <div
            class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3">
            <h1>Returns</h1>
          </div>
          
          <h2>Unit Details</h2>
          <form id="ReturnsForm">
            <div class="row">
              <div class="col-md-3"> 
                <label for="SerialNumber">Serial Number:</label>
                <input type="text" class="form-control" id="SerialNumber">
                <label for="History">Device History:</label>
                <select class="form-control" id="History">
                  <option value="NONE"></option>
                  <option value="CUSTOMER">Customer</option>
                  <option value="CEM Return">CEM Return</option>
                  <option value="Other">Other (See Comments)</option>
                </select>
                <label for="IMEI">IMEI:</label>
                <input type="text" class="form-control" id="IMEI">
                <label for="BatterySerial">Battery Serial:</label>
                <input type="text" class="form-control" id="BatterySerial">
                <label for="BatteryVoltage">Battery Voltage:</label>
                <input type="text" class="form-control" id="BatteryVoltage">
                <label for="FaultCategory">Fault Category:</label>
                <select class="form-control" id="FaultCategory">
                  <option value="NONE"></option>
                  <option value="ANTENNA ISSUE">Antenna</option>
                  <option value="BATTERY ISSUE">Battery</option>
                  <option value="CONFIG ISSUE">Config</option>
                  <option value="DAMAGED">Damaged</option>
                  <option value="DISTANCE MEASUREMENT">Distance</option>
                  <option value="HLC">HLC</option>
                  <option value="MODEM ISSUE">Modem</option>
                  <option value="NFF">No Fault Found</option>
                  <option value="SETTINGS ISSUE">Settings</option>
                  <option value="SIM ISSUE">Sim</option>
                  <option value="TELIT">Telit</option>
                  <option value="WEAR AND TEAR">Wear and Tear</option>
                  <option value="WONT WAKE">Won't Wake</option>
                </select>
                <label for="ReturnReason">Reason For Return:</label>
                <select class="form-control" id="ReturnReason">
                  <option value="NONE"></option>
                  <option value="No Reason Given">No Reason Given</option>
                  <option value="Connection Issues">Connection Issues</option>
                  <option value="Damaged">Damaged</option>
                  <option value="Distance Measurement Issues">Distance Measurement Issues</option>
                  <option value="Low Voltage">Low Voltage</option>
                  <option value="Swapped">Swapped</option>
                  <option value="Wire Broken">Wire Broken</option>
                  <option value="Won't Wake Up">Won't Wake Up</option>
                </select>
              </div>
              <div class="col-md-3">
                <label for="Product">Product:</label>
                <select class="form-control" id="Product" onchange=ProductSelect(Product)>
                  <option value="NONE"></option>
                  <option value="LIDoTT ALARM">Alarm</option>
                  <option value="LIDoTT SMART V1">Smart V1</option>
                  <option value="LIDoTT SMART V2">Smart V2</option>
                </select>
                <label for="ProductVariant">Product:</label>
                <select class="form-control" id="ProductVariant" onchange=ProductSelect(Product)>
                  <option value="NONE"></option>
                  <option value="A">A Variant</option>
                  <option value="B">B Variant</option>
                  <option value="C">C Variant</option>
                  <option value="D">D Variant</option>
                </select>
                <label for="ProductCode">Product Code:</label>
                <input type="text" class="form-control" id="ProductCode">
                <label for="Tags">Tag(s):</label>
                <input type="text" class="form-control" id="Tags">
                <label for="DateReturned">Date Returned:</label>
                <input type="datetime-local" class="form-control" id="DateReturned">
                <label for="Customer">Customer:</label>
                <input type="text" class="form-control" id="Customer">
                <label for="FixApplied">Fix Applied:</label>
                <select class="form-control" id="FixApplied">
                  <option value="NONE"></option>
                  <option value="NFF">No Fault Found</option>
                  <option value="CONFIG UPDATE">Config Update</option>
                  <option value="FIRMWARE UPDATE">Firmware Update</option>
                  <option value="MODEM UPDATE">Modem Update</option>
                  <option value="MODEM FIX">Modem Fix</option>
                  <option value="REPLACED ANTENNA">Replaced Antenna</option>
                  <option value="RESET PG">Reset PG</option>
                  <option value="TELIT">Telit</option>
                  <option value="TIGHTENED ANTENNA">Tightened Antenna</option>
                  <option value="UNBOOTSTRAPPED">Un/Re-Bootstrapped</option>
                </select>
              </div>
              <div class="col-md-3">  
                <label for="VisualInspection">Visual Inspection:</label>
                <select class="form-control" id="VisualInspection">
                  <option value="NONE"></option>
                  <option value="PASS">Pass</option>
                  <option value="FAIL">Fail</option>
                </select>
                <label for="VisualComments">Visual Comments:</label>
                <input type="text" class="form-control" id="VisualComments">
                <label for="CommsTest">Comms Test:</label>
                <select class="form-control" id="CommsTest">
                  <option value="NONE"></option>
                  <option value="PASS">Pass</option>
                  <option value="FAIL">Fail</option>
                </select>
                <label for="CommsError">Comms Error:</label>
                <input type="text" class="form-control" id="CommsError">
                <label for="SensorTest">Sensor Test:</label>
                <select class="form-control" id="SensorTest">
                  <option value="NONE"></option>
                  <option value="PASS">Pass</option>
                  <option value="FAIL">Fail</option>
                </select>
                <label for="SensorError">Sensor Error:</label>
                <input type="text" class="form-control" id="SensorError">
                <label class="label" for="Status">Final Status:</label>
                <select class="form-control" id="Status">
                  <option value="NONE"></option>
                  <option value="PASS">Pass</option>
                  <option value="FAIL">Fail</option>
                </select>
              </div>              
            </div>
            <label for="Comments" class="form-label">Comments</label>
            <textarea class="form-control col-md-9" id="Comments" rows="4"></textarea>
            <button id="submitReturnsUnitDetails" type="button" class="btn btn-primary form-control col-md-6" onclick="ReturnsAPIFormat(ReturnsForm); this.blur();">Submit</button>
            <button id="clearReturnsForm" type="button" class="btn btn-primary form-control col-md-3" onclick="ReturnsForm.reset(); this.blur();">Clear Form</button>
          </form>
          <h2>Get Unit Details</h2>
          <div class="row">
        <form id="ReturnsGet">
          <div class="row">
            <div class="col-md-3">
              <label for="ReturnsFilter" class="form-label">Filter Type:</label>
              <select id="ReturnsFilter" class="form-control">
                  <option value="SerialNumber">Serial Number</option>
                  <option value="BatterySerial">Battery Serial</option>
                  <option value="IMEI">IMEI</option>
                  <option value="FailState">Fail State</option>
              </select>
            </div>
            <div class="col-md-3">
              <label for="ReturnsFilterInput" class="form-label">Filter By:</label>
              <input type="text" id="ReturnsFilterInput" class="form-control">
            </div>
            <div class="col-md-3">
              <label for="getTestDetailsButton" class="form-label">Get Data:</label>
              <button id="getTestDetailsButton" type="button" class="btn btn-primary form-control bottom" onclick="getReturnsFilterAPI(ReturnsFilter,ReturnsFilterInput)">Get Results</button>
            </div>
          </div>
        </form>
        <table id="UnListReturn" class="table table-bordered table-responsive table-hover table-sm table-dark" width="900" height="1000"></table>
      </main>
      </div>
    </div>
    
    <div id="Testing" class="tabcontent">
      <div class="row">
      <main>
        <div class="col-md-auto ml-sm-auto col-lg-10 px-md-4">
          <h1  class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3">Test Data</h1>

        <h2>Testing Manual Entry</h2>
        <form id="TestForm">
          <div class="row">
            <div class="col-md-3">
              <label for="SerialNumber">Serial Number:</label>
              <input type="number" class="form-control" id="SerialNumber">
              <label for="IMEI">IMEI:</label>
              <input type="number" class="form-control" id="IMEI">
              <label for="BatterySerial">Battery Serial:</label>
              <input type="number" class="form-control" id="BatterySerial">
              <label for="BatteryVoltage">Battery Voltage:</label>
              <input type="text" class="form-control" id="BatteryVoltage">
              <label for="DeviceName">Device Name:</label>
              <input type="text" class="form-control" id="DeviceName">
              <label for="DateOfTest">Date of Test:</label>
              <input type="datetime-local" class="form-control" id="DateOfTest">
              <label for="WS46Plus">WS46+ Settings:</label>
              <input type="text" class="form-control" id="WS46Plus">
              <label for="Bootstrapped">Bootstrap Time:</label>
              <input type="datetime-local" class="form-control" id="Bootstrapped">
              <label for="ATEX">Pass/Fail: *</label>
              <select class="form-control" id="ATEX">
                <option class="option" value="NONE"></option>
                <option class="option" value="PASS">Pass</option>
                <option class="option" value="FAIL">Fail</option>
              </select>
            </div>
            <div class="col-md-3">  
              <label for="PrimaryDistance">First Distance:</label>
              <input type="number" class="form-control" id="PrimaryDistance">
              <label for="SecondaryDistance">Second Distance:</label>
              <input type="number" class="form-control" id="SecondaryDistance">
              <label for="TertiaryDistance">Third Distance</label>
              <input type="number" class="form-control" id="TertiaryDistance">
              <label for="ModbusOffset">Modbus Offset:</label>
              <input type="number" class="form-control" id="ModbusOffset">
              <label for="ModemVersion">Modem Version:</label>
              <input type="text" class="form-control" id="ModemVersion">
              <label for="FirmwareVersion">Firmware Version:</label>
              <input type="text" class="form-control" id="FirmwareVersion">
              <label for="WS46Hash">WS46# Settings:</label>
              <select class="form-control" id="WS46Hash">
                <option class="option" value="NONE"></option>
                <option class="option" value="CAT-M1 Only (0)">CAT-M1 Only (0)</option>
                <option class="option" value="NB-IoT Only (1)">NB-IoT Only (1)</option>
                <option class="option" value="CAT-M1 Preferred (2)">CAT-M1 Only (2)</option>
                <option class="option" value="NB-IoT Preferred (3)">NB-IoT Preferred (3)</option>
              </select>
              <label for="Registered">Registration Time:</label>
              <input type="datetime-local" class="form-control" id="Registered">
              <label for="FailReason">Fail Reason:</label>
              <input type="text" class="form-control" id="FailReason">
            </div>
            <div class="col-md-3">  
              <label for="LastAttemptedSend" class="form-label">Last Attempted Send:</label>
              <input type="datetime-local" id="LastAttemptedSend" class="form-control">
              <label for="LastSuccessfulSend">Last Successful Send:</label>
              <input type="datetime-local" id="LastSuccessfulSend" class="form-control">
              <label for="Coordinates">Coordinates:</label>
              <input type="text" class="form-control" id="Coordinates">
              <label for="MobileNetwork">Mobile Network:</label>
              <input class="form-control" id="MobileNetwork">
              <label for="ConnectionType">Connection Type:</label>
              <select class="form-control" id="ConnectionType">
                <option class="option" value="NONE"></option>
                <option class="option" value="CAT-M1">CAT-M1</option>
                <option class="option" value="GSM">GSM</option>
                <option class="option" value="NB-IOT">NB-IOT</option>
              </select>
              <label for="RSSI">RSSI:</label>
              <input type="number" class="form-control" id="RSSI">
              <label for="Exec">Exec Time:</label>
              <input type="datetime-local" class="form-control" id="Exec">
              <label for="CompetentPerson">Competent Person:</label>
              <input type="text" class="form-control" id="CompetentPerson">
              <label for="PointOfOrigin">Point Of Origin:</label>
              <input type="text" class="form-control" placeholder="Production" id="PointOfOrigin">
            </div>
          </div>
        </form>
        <button id="submitTestUnitDetails" type="button" class="btn btn-primary form-control mt-4 col-md-6" onclick="TestingAPIFormat(TestForm); TestForm.reset(); this.blur()">Submit</button>
        <button id="clearTestingButton" type="button" class="btn btn-primary form-control mt-4 col-md-3" onclick="TestForm.reset(); this.blur()">Clear Form</button>
        <div class="pt-2 pb-2 mb-3 "></div>
        
        
        <h2>Testing Upload</h2>
        <form>
          <input type="file" id="fileInput" accept=".csv" />
          <pre id="output"></pre>
      </form>
        <h2>Get Unit Details</h2>
        <form id="TestForm">
          <div class="row">
            <div class="col-md-3">
              <label for="TestFilter" class="form-label">Filter Type:</label>
              <select id="TestFilter" class="form-control">
                  <option value="SerialNumber">Serial Number</option>
                  <option value="BatterySerial">Battery Serial</option>
                  <option value="IMEI">IMEI</option>
                  <option value="FailState">Fail State</option>
              </select>
            </div>
            <div class="col-md-3">
              <label for="TestFilterInput" class="form-label">Filter By:</label>
              <input type="text" id="TestFilterInput" class="form-control">
            </div>
            <div class="col-md-3">
              <label for="getTestDetailsButton" class="form-label">Get Data:</label>
              <button id="getTestDetailsButton" type="button" class="btn btn-primary form-control bottom" onclick="getTestingFilterAPI(TestFilter,TestFilterInput)">Get Results</button>
            </div>
          </div>
        </form>
      </div>
      <div class="pt-2 pb-2 mb-3 "></div>
        <table id="UnListTest" class="table table-bordered table-responsive table-hover table-sm table-dark" width="900" height="1000"></table>
      </main>
      </div>
    </div>
  </div>   
</body>
<script>
  document.getElementById('fileInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
              Papa.parse(file, {
                  worker: true,
                  step: function(results) {
                    CSVParse(results.data)
                  },
                  complete: function() {
                      window.alert('CSV file successfully processed');
                  },
                  error: function(error) {
                      window.alert('Error parsing CSV:', error);
                  }
                }
              );
            }
        });
</script>
</html>